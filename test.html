<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Grid</title>
</head>
<style>

    *{
        padding : 0;
        margin : 0;
        box-sizing: border-box;
    }

    .game-cell{
        transition: all 0.1s ease-in;
    }
</style>
<body>
    
    <div id="grid-container">

    </div>
    <script>

        class Cat {
            constructor(x = 0, y = 0){
                this.x = x;
                this.y = y;
                this.moving = false;
            }
        }
        const cell_height = 50
        const cell_width = 50
        const rows = 12
        const cols = 12
        const cat = new Cat();
        let targetX, targetY;

        const board = []
        let grid = document.getElementById('grid-container');

        const addEntity = (x, y, url) => {
                var img = document.createElement('IMG');
                img.src = url;
                img.style.height = 'auto';
                img.style.width = '100%';
                // board[x][y].div.innerHTML = ''
                board[x][y].div.appendChild(img);
        }

        const createCat = () => {
            board[cat.x][cat.y].div.innerHTML = ''
            // cat.div = document.createElement('DIV')
            // cat.div.style.position = 'absolute'
            // cat.div.style.left = board[cat.x][cat.y].div.left;
            // cat.div.style.top = board[cat.x][cat.y].div.top;
            // cat.div.style.width = board[cat.x][cat.y].div.width
            // cat.div.style.height = board[cat.x][cat.y].div.height
            // cat.div.style.zIndex = 5000;
            // var img = document.createElement('IMG')
            // img.src = "./public/assets/cat.png"
            // img.style.height = 'auto'
            // img.style.width = '100%'
            // cat.div.appendChild(img)
            // cat.div.classList.add('game-cell')
            // grid.appendChild(cat.div);
        }
        
        const transitionEndEvent = (e) => {
            let cells = document.querySelectorAll('.game-cell');
            console.log(board)
            board[cat.x][cat.y].div.removeChild(board[cat.x][cat.y].div.querySelector('img'))
            cat.x = targetX;
            cat.y = targetY;
            cat.moving = false;
        }

        // init board
        for (let i = 0; i < rows; ++i) {
            board.push(new Array());
            for (let j = 0; j < cols; ++j) {
                let div = document.createElement('div');
                div.classList.add('game-cell')
                div.style.position = 'absolute';
                board[i][j] = 
                {   
                    left : i * cell_width, 
                    top : j * cell_height, 
                    div : div
                }
                let outer = document.createElement('div');
                outer.style.position = 'absolute';
                outer.style.width = cell_width + "px";
                outer.style.height = cell_height + "px";
                outer.style.left = board[i][j].left + 'px';
                outer.style.top = board[i][j].top + 'px';
                outer.style.backgroundColor = ((i + j) & 1) == 0 ? 'red' : 'blue';
                div.style.left = board[i][j].left + 'px';
                div.style.top = board[i][j].top + 'px';
                div.style.width = cell_width + "px";
                div.style.height = cell_height + "px";
                div.innerHTML = rows * i + j
                grid.appendChild(outer);
                grid.appendChild(div);
                outer.style.zIndex = -1;
                addEntity(i, j, "./public/assets/mice.png")
                div.addEventListener('webkitTransitionEnd', transitionEndEvent)
                div.addEventListener('transitionend', transitionEndEvent)
            }
        }

        addEntity(cat.x, cat.y, "./public/assets/cat.png");
        // createCat();

        document.onkeydown = movecat;

        function movecat (e) {
            let newX = cat.x, newY = cat.y;
            if (e.keyCode == '38') {// up arrow
                newY--;
                // console.log("moves up")
            }
            else if (e.keyCode == '40') {// down arrow
                newY++;
                // console.log("moves down")
            }
            else if (e.keyCode == '37') {// left arrow
                newX--;
                // console.log("moves left")
            }
            else if (e.keyCode == '39') {// right arrow
                newX++;
                // console.log("moves right")
            }
            move(cat.x, cat.y, newX, newY);
        }        

        const move = (x1, y1, x2, y2) => {
            if(!cat.moving && x2 >= 0 && y2 >= 0 && x2 < rows &&  y2 < cols){
                console.log(x1, x2, cols, rows);
                let from = board[x1][y1];
                let to = board[x2][y2];
                let tempL = to.left;
                let tempT = to.top;
                from.div.classList.add('animating');
                from.div.style.left = tempL + 'px';
                from.div.style.top = tempT + 'px';
                let tempD = to.div;
                to.div = from.div;
                from.div = tempD;
                targetX = x2; 
                targetY = y2;
                cat.moving = true;
            }
        }

    </script>
</body>
</html>